/*
 DWWLLLLLLjjttjDW#################Gjttttttttttttttt
EWKLLLLLGjtjjD##################WWGjtttttttttttttt
EWKLLLLLGjjtD#####################KLtttttttttttttt
EWKLLLLLLjtDW###WWW#W##WWW#########jtttttttttttttt
EWELLLLLGjj####WWWWWWWKKWWW########Dtttttttttttttt
EWELLLLLLjGW##WWEEDGGLLGDEKWW#######fttttttttttttt
KWELLLLLGj##WWKGti;;,,;;itfGEW######Ettttttttttttt
KWDLLLLLLLWWWKLi,,::::,;;;iijDK######ftttttttttttt
EWDLLLLLLKWWEGj,::.:::,,;;iitjLEW####Ltttttttttttt
DWGLLLLLLWWELLj,:.:::::,;;iittfLDK###Ktttttttttttt
DWGLLLLLDEDLjjt;:...:::,;;iiitjfLDE###tttttttttttt
EWGLLLLLDGLfjji:...:::,,;;iiitjjLGGE#Wtttttttttttt
EWGLLfLLGLfjti,:...:::,;;;iiittjfLLG#Wttttjjtttttt
DWLLLLLLDLft;:..::..::,;iiiiitjjfLLL##ttttjjjjjjtt
DWLLLLLGGfj;:...:::::,,;iiiiittjfLLLWWttttjjtttttt
EWLLLLLGGjj,...:,;;,,:,;iiiiittjfLLLKEttttjjjjjjjj
EWLLff:iEEE;...,;iijji;;;i;iiitjfLLfKGtjjjjjjjjjjj
EWEDEij.;jiLKEjj;::;itti;;;;;itjfLLLKfjjjjjjjjjjjj
EWKKK,,.,;:..ffjtitjti;t;,i;ijfLLLLfKjjjjjjjjjjjjj
EWWWWt:.,,:...,;jLttjft;,;iijLGDEGLLKtjjjjjjjjjjjj
EEDDGi.;i.....:::,jDDt;j;tjjfjtLDEGfLjjjjjjjjjjjjj
EEGGG,;:,::..::,,;itji;iWDDGftitfDGLtjjjjjjjjjjjjj
KDGGL,,,:.....:,,;;;,i,L;fEDLtfLGGLLjjjjjjjjjjjjjj
KDLGL,.,::....:,,,;,,;;.;fKDEEDLLGLfjjjjjjjjjjjjjj
KDLLL::::......:,,;,::::;LGGGffDDDKGfjjjjjjjjjjjjj
KGLGLi ::......::,;;:,,,iLGGLffLGfiKtjjjjjjjjjjjjj
KDLGLGf::......::,t,,,:,iLGGGfjLLt;jfjjjjjjjjjjjjj
EELGfLj::......:,ii:...,iLGDGLffLfjfjjfjjjjjjjjjjj
GDGGGLt:.......:;;;::;.:tLLEGLffLfjjjjjjjjjjjjjjjj
LGGGGLj:.......:,,:;i,,,LDLEGLLLffjjjjjjjjjjjjjjjj
LGGGGLt........:::::,;:;fKLEDLLLfjjjjjjjjjjtjjjjjj
LGGGGf;;.......:::::,,ijt.,EGLLLfitiiiiiittttttttt
LGGGGf.,;.::...:,:::,,;  ;LfGGLLjiititittittiitiii
fGGGLf::t:,i:..,,:.;;L :GLjfGLLLiitiiitiiiiiitiiii
fGGGLf::;i;j;:::,;,tGt;;tLLGGLLjtjittiit;LiittLiii
GGGGLt..ij,f;:::;ijf:,,ijLGLGGLttjj;jijjtiLiitiiii
GGLLL;.:ti,,.::;ti,;,jifGDGGLLjitjjttttttfttt;fiii
LfKKW..:i,,,:,i;,,,iftLDDDGLGftttfjjjtittfji;iiiii
iLKWj...:.::,,,,,;tjjDEEDDGGfttttitiijitjttttijiii
iiKj,..:...:,ii;itfGEDEDDGGLttttttiittiittitiitiii
iijG:.......,iitfDKKGLDGGGLfLLLGLLLLLfffffjjjttiii
ttiL,.......:,itt;;ittfLDLffLLLLLLLLLGGGGKWWWKEEDG
titi,. .....::,tiiijjfLfGEDLLLLLLLLLLLGGGKWWWEEDGG
itit: ........,titjfLGGGLEWKDLfLLLLLLLLLLKKWKEDDGL
tttt:.........,;tGDDGGEDDGWKKKKGLfLLfLLLLKKDEEEGGL
Gttt:.........::;fjjfLLEKDK#KEKWEDLfffLLLKKDDEEGGL
jLji:..........:;fjffLfGWEKWKKKKKKEEDLfffKKKWKEGLL
iGff............;fjLLDGGDWEWEKKKKKKKEEDGLKKKWKDGGL
;tW;,..........:ijLGEKEGD#KKEKKKKWKKKKEDGDKKKEDGLL
jitG:.........:,ifLLGDGDE#WKEEKKKWKKKKEEEDDKKKKKEL
jjiL ........::;fLtjfLEKWWWKEEWEKKKKKKEEEDDEKKDEKf
jjti........::,tLitjLWKW#KWKEKKEKKKKKEEEEEEGKKKKEL
fff:........:,ifL;tfKWK#WWKKEKKKKKKEKEEEEEEDGGGGLf
ff:......::::;tG;tfEKKWKKWKKKKKEKKKEEEEEEEEDGGGLLL
G;......::::,iLtitfKKKWKWKKKKKKKEEEEEEEEEEEDDGLLLf
i......:,,:,tLtitjGKKKKKWWKKKKEEEEEEEEEEEEDDDDLLLf
... ....,;;tGiittjKKWWEWWKKKKEEEEEEEEEEEEDDDDDGLLf
.......:itjLfLitjLKEKKWWKKKEEEEEEEEEEEEEEDDDDDDLff
......:;ijLGjGtjjEKEKKWKEEEEEEEEEEEDEEEEDDDEDDDGLf
.....:;iifLLGLfjfWKKKWKEKKEEEEEEEEEDEDDEDDDEDEDDLf */

package com.dajie.wika.service.impl;

import java.util.Date;
import java.util.List;

import org.apache.commons.lang3.math.NumberUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.dajie.common.dubbo.tolerance.Idempotent;
import com.dajie.common.util.ParamXssStripper;
import com.dajie.wika.cache.CacheFactory;
import com.dajie.wika.constants.DJAccountConstant;
import com.dajie.wika.constants.GenderType;
import com.dajie.wika.constants.MobileConfirmConstant;
import com.dajie.wika.constants.PlatformConstant;
import com.dajie.wika.constants.PrivacyType;
import com.dajie.wika.constants.SourceTypeConstant;
import com.dajie.wika.constants.UserActivationConstant;
import com.dajie.wika.constants.UserStatusConstant;
import com.dajie.wika.constants.returncode.AccountReturnCodeConstant;
import com.dajie.wika.constants.returncode.ResultCodeConstant;
import com.dajie.wika.dao.PlatformMapDAO;
import com.dajie.wika.dao.UserBaseDAO;
import com.dajie.wika.model.DJLoginReturn;
import com.dajie.wika.model.DJUserInfo;
import com.dajie.wika.model.PlatformMap;
import com.dajie.wika.model.UserAvatarSet;
import com.dajie.wika.model.UserBase;
import com.dajie.wika.model.UserOccupation;
import com.dajie.wika.model.UserPrivacySettings;
import com.dajie.wika.model.wrapper.ActiveDJReturn;
import com.dajie.wika.model.wrapper.LoginReturn;
import com.dajie.wika.model.wrapper.LoginUserView;
import com.dajie.wika.model.wrapper.RegisterReturn;
import com.dajie.wika.service.AccountService;
import com.dajie.wika.service.IdSequenceService;
import com.dajie.wika.service.MessageService;
import com.dajie.wika.service.OccupationService;
import com.dajie.wika.service.QRcodeService;
import com.dajie.wika.service.ResourceService;
import com.dajie.wika.service.SMSSendService;
import com.dajie.wika.service.ShortUrlService;
import com.dajie.wika.service.UserCountService;
import com.dajie.wika.service.UserSettingsService;
import com.dajie.wika.service.utils.EmojiFilterUtil;
import com.dajie.wika.service.utils.SMSUtil;
import com.dajie.wika.service.utils.SecurityUtils;
import com.dajie.wika.service.utils.StringUtil;
import com.dajie.wika.service.utils.UserInfoValidator;

@Service("accountService")
public class AccountServiceImpl implements AccountService {

	private Logger logger = LoggerFactory.getLogger(AccountServiceImpl.class);
	@Autowired
	private UserBaseDAO userBaseDAO;

	@Autowired
	private PlatformMapDAO thirdPlatformMapDAO;

	@Autowired
	private UserSettingsService userSettingsService;

	@Autowired
	private OccupationService occupationService;

	@Autowired
	private UserCountService userCountService;

	@Autowired
	private ShortUrlService shortUrlService;

	@Autowired
	private ResourceService resourceService;

	@Autowired
	private MessageService messageService;

	@Autowired
	private QRcodeService qRcodeService;

	@Autowired
	private DJAccountService djAccountService;

	@Autowired
	private SMSSendService smsSendService;

	// cache
	@Autowired
	private CacheFactory cacheFactory;

	@Autowired
	private IdSequenceService idSequenceService;

	// 单个用户一天尝试发短信验证码的限制
	private static final int VERIFY_CODE_RETRY_TIME = 10;

	// 用户默认模板
	private static final int DEFAULT_WIKA_TEMPLATE = 1;

	// 用户默认头像
	private static final String DEFAULT_USER_AVATAR = "http://9.f1.dajieimg.com/group1/M00/48/92/CgpAo1Ld6G6AGBU1AAABCsDgQos631.png";

	@Override
	@Idempotent(value = false)
	public LoginReturn login(String mobile, String password, int source) {
		LoginReturn loginReturn = new LoginReturn();
		UserBase userBase = getUserBaseByMobile(mobile);
		int loginReturnCode = ResultCodeConstant.OP_FAIL;
		if (null == userBase) {
			loginReturnCode = AccountReturnCodeConstant.ACCOUNT_NOT_EXIST;
		} else {
			String pwdMD5 = SecurityUtils.handlePassword(password,
					userBase.getUserId() + "");
			if (userBase.getStatus() == UserStatusConstant.USER_FREEZE) {
				loginReturnCode = AccountReturnCodeConstant.ACCOUNT_FREEZEN;
			} else if (!pwdMD5.equals(userBase.getPassword())) {
				loginReturnCode = AccountReturnCodeConstant.PASSWORD_ERROR;
			} else if (pwdMD5.equals(userBase.getPassword())) {
				// 成功登陆，设置uid,短链
				int userId = userBase.getUserId();
				loginReturn.setUserId(userId);
				String profileShortUrl = shortUrlService
						.genWikaProfileShortUrl(userId);
				loginReturn.setShortUrl(profileShortUrl);

				UserOccupation occupation = occupationService
						.getOccupation(userBase.getUserId());
				// 未完成信息，只返回userId
				if (!isCompleteRequriedInfo(userBase, occupation, source)) {
					loginReturnCode = AccountReturnCodeConstant.BASE_INFO_UNFINISED;
				} else {
					loginReturnCode = ResultCodeConstant.OP_SUCC;
					// 登陆成功后附带基本信息
					LoginUserView userView = constructLoginUserView(userBase,
							null);
					loginReturn.setLoginUserView(userView);

					// 更新用户激活状态
					activeWithLogin(userBase, source);
				}
			}
		}
		// 设置返回码
		loginReturn.setReturnCode(loginReturnCode);
		return loginReturn;
	}

	@Override
	@Idempotent(value = false)
	public LoginReturn loginWithDJ(String account, String password, int source) {
		LoginReturn loginReturn = new LoginReturn();

		// 登陆大街，获取DjId
		DJLoginReturn djLoginReturn = djAccountService.loginWithDJ(account,
				password);
		int djId = djLoginReturn.getDjId();
		int code = djLoginReturn.getCode();
		if (code == DJAccountConstant.ACCOUNT_LOGIN_SUC) {
			// 是否是已经登陆过的帐户
			PlatformMap map = thirdPlatformMapDAO.getPlatformMap(
					djLoginReturn.getDjId() + "", PlatformConstant.DA_JIE);
			int loginReturnCode = ResultCodeConstant.OP_FAIL;
			// 第一次登陆，插入基本信息
			if (map == null) {
				// 从大街拉取基本信息
				DJUserInfo djUserInfo = djAccountService
						.getDjUserInfoByDjId(djId);
				int userId = idSequenceService.getNextUserId();

				// 从大街信息初始化待插入用户信息
				UserBase userBase = convert2UserBase(djUserInfo, userId);
				// platform
				PlatformMap platformMap = new PlatformMap();
				platformMap.setAccessTime(new Date());
				platformMap.setPlatformType(PlatformConstant.DA_JIE);
				platformMap.setPlatformUid(djUserInfo.getDjId() + "");
				platformMap.setUserId(userId);
				try {
					int platformInsert = thirdPlatformMapDAO
							.insert(platformMap);
					logger.info("login with dj insert platform_map");
					if (platformInsert > 0) {
						userBase.setMobileConfirmed(MobileConfirmConstant.MOBILE_NOT_CONFIRMED);
						userBase.setWikaTemplate(DEFAULT_WIKA_TEMPLATE);
						int activation = source == SourceTypeConstant.WAP_SOURCE ? UserActivationConstant.WAP_ACTIVE
								: UserActivationConstant.APP_AVTIVE;
						userBase.setActivation(activation);
						int userbaseInsert = userBaseDAO.insert(userBase);
						logger.info("login with dj insert userbase,mobile="
								+ userBase.getMobile());
						// 用户表插入成功
						if (userbaseInsert > 0) {
							// usersetting
							userSettingsService.addDefaultUserSettings(userId);
							logger.info("login with dj insert user default settings");
							// occupation
							UserOccupation userOccupation = convert2UserOccupation(
									djUserInfo, userId);
							occupationService.updateOccupation(userOccupation);

							// 登陆成功
							// 更新身价
							refreshUserInfoValue(userId);
							loginReturn
									.setReturnCode(AccountReturnCodeConstant.MOBILE_UNBINDED);
							loginReturn.setUserId(userId);
							LoginUserView loginUserView = constructLoginUserView(
									userBase, userOccupation);
							logger.info("login with dajie return mobile="
									+ loginUserView.getMobile());
							loginReturn.setLoginUserView(loginUserView);
							String profileShortUrl = shortUrlService
									.genWikaProfileShortUrl(userId);
							loginReturn.setShortUrl(profileShortUrl);
						}
						// 用户表插入失败
						else {
							logger.info("platfrom_map insert success,userbase insert error.start rollback");
							// 回滚第三方映射表
							thirdPlatformMapDAO.delete(
									platformMap.getPlatformUid(),
									platformMap.getPlatformType());
							loginReturn
									.setReturnCode(ResultCodeConstant.OP_FAIL);
							loginReturn.setUserId(0);
						}
					} else {
						loginReturn.setReturnCode(ResultCodeConstant.OP_FAIL);
						loginReturn.setUserId(0);
					}
				} catch (Exception e) {
					logger.error("login with dj insert info error.", e);
					loginReturn.setReturnCode(ResultCodeConstant.OP_FAIL);
					loginReturn.setUserId(0);
					return loginReturn;
				}
			}
			// 已经登陆过
			else {
				UserBase userBase = getUserBaseById(map.getUserId());
				if (userBase != null) {
					// 用户是否被冻结
					if (userBase.getStatus() != UserStatusConstant.USER_FREEZE) {
						if (userBase.getMobile() != null
								&& userBase.getMobileConfirmed() == MobileConfirmConstant.MOBILE_CONFIRMED) {
							UserOccupation occupation = occupationService
									.getOccupation(userBase.getUserId());
							if (isCompleteRequriedInfo(userBase, occupation,
									source)) {
								loginReturnCode = ResultCodeConstant.OP_SUCC;
								// 更新用户激活状态
								activeWithLogin(userBase, source);
							} else {
								loginReturnCode = AccountReturnCodeConstant.BASE_INFO_UNFINISED;
							}
							LoginUserView loginUserView = constructLoginUserView(
									userBase, occupation);
							loginReturn.setLoginUserView(loginUserView);
						} else {
							// TODO 更新从大街获取的信息
							// 有没有确认的手机号，返回提示
							if (userBase.getMobile() != null) {
								LoginUserView loginUserView = constructLoginUserView(
										userBase, null);
								loginReturn.setLoginUserView(loginUserView);
							}
							loginReturnCode = AccountReturnCodeConstant.MOBILE_UNBINDED;
						}
						loginReturn.setUserId(userBase.getUserId());
						String profileShortUrl = shortUrlService
								.genWikaProfileShortUrl(userBase.getUserId());
						loginReturn.setShortUrl(profileShortUrl);
					} else {
						loginReturnCode = AccountReturnCodeConstant.ACCOUNT_FREEZEN;
						loginReturn.setUserId(0);
					}
				} else {
					logger.info("get user_base info by userId return null");
					// 从platfrom里面能查到uid,在userbase表查不出来，如果执行时间与接入时间间隔很短，可能是延迟，
					// v如果时间很长，是错误数据，清除platform_map表里面的数据
					// 下次重走注册流程
					long access = map.getAccessTime().getTime();
					long runtime = System.currentTimeMillis();
					// 阈值 10分钟
					if ((runtime - access) > 1000 * 60 * 10) {
						logger.error("user info data error,please check");
						// TODO 清除数据
					}
					loginReturnCode = ResultCodeConstant.OP_FAIL;
				}
				loginReturn.setReturnCode(loginReturnCode);
			}

		} else {
			if (code == DJAccountConstant.ACCOUNT_NOT_EXIST) {
				loginReturn
						.setReturnCode(AccountReturnCodeConstant.DJ_ACCOUNT_NO_EXIST);
			} else if (code == DJAccountConstant.ACCOUNT_PASSWORD_ERROR) {
				loginReturn
						.setReturnCode(AccountReturnCodeConstant.DJ_ACCOUNT_PASSWORD_ERROR);
			} else if (code == DJAccountConstant.ACCOUNT_DISABLE) {
				loginReturn
						.setReturnCode(AccountReturnCodeConstant.DJ_ACCOUNT_DISABLE);
			} else {
				loginReturn
						.setReturnCode(AccountReturnCodeConstant.DJ_ACCOUNT_LOGIN_FAIL);
			}
			loginReturn.setUserId(0);
		}
		return loginReturn;
	}

	public int loginWithThirdPlatform(String authToken, int thirdPlatformType) {
		// 调用获取基本信息

		// 是否已经注册

		return 0;
	}

	@Override
	public int getVerifyCode(String mobile) {
		if (!StringUtil.isPhoneNumber(mobile)) {
			logger.info("error mobile :" + mobile);
			return ResultCodeConstant.OP_FAIL;
		}
		// 尝试次数
		int phoneHasSend = NumberUtils.toInt(cacheFactory
				.getPhoneCodeSendCount(mobile));
		if (phoneHasSend > VERIFY_CODE_RETRY_TIME) {
			logger.info("get verifyCode out of limit,mobile=" + mobile);
			return AccountReturnCodeConstant.RETRY_TIME_LIMIT;
		} else {
			cacheFactory.updatePhoneCodeCount(mobile, phoneHasSend + "");
		}
		try {
			// 构建短信下发内容
			String code = getPhoneCode(mobile);
			String msg = code
					+ " （微卡手机验证码，10分钟内有效）。应用下载地址http://www.weika001.com/system/getapp";
			logger.info("sendVerifyMessage code=" + code);

			// 发送短信
			int sendReturn = smsSendService.smsSend(mobile, msg);
			if (sendReturn > 0) {
				return ResultCodeConstant.OP_SUCC;
			} else {
				return ResultCodeConstant.OP_FAIL;
			}

		} catch (Exception e) {
			logger.error("AccountService sendVerifyMessage error! ", e);
			return ResultCodeConstant.OP_FAIL;
		}
	}

	@Override
	@Idempotent(value = false)
	public RegisterReturn register(String mobile, String verifyCode,
			String password, int source) {
		RegisterReturn registerReturn = new RegisterReturn();
		boolean validateResult = validatePhoneCode(mobile, verifyCode);
		if (!validateResult) {
			logger.info("register : verify code error,mobile = " + mobile);
			registerReturn
					.setReturnCode(AccountReturnCodeConstant.VERIFY_CODE_ERROR);
			return registerReturn;
		} else {
			boolean mobileValid = UserInfoValidator.mobileValidate(mobile);
			if (!mobileValid) {
				logger.info("register : mobile input is unvalid ,mobile = "
						+ mobile);
				registerReturn
						.setReturnCode(AccountReturnCodeConstant.MOBILE_FORMAT_ERROR);
				return registerReturn;
			}
			boolean passwordValid = UserInfoValidator
					.passwordValidate(password);
			if (!passwordValid) {
				logger.info("register : password input is unvalid ,mobile = "
						+ mobile);
				registerReturn
						.setReturnCode(AccountReturnCodeConstant.PASSWORD_FORMAT_ERROR);
				return registerReturn;
			}
			UserBase userBase = getUserBaseByMobile(mobile);
			if (userBase == null) {
				userBase = new UserBase();
				userBase.setMobile(mobile);
				try {
					int userId = idSequenceService.getNextUserId();
					userBase.setUserId(userId);
					userBase.setPassword(SecurityUtils.handlePassword(password,
							userId + ""));
					userBase.setActivation(source == SourceTypeConstant.WAP_SOURCE ? UserActivationConstant.WAP_ACTIVE
							: UserActivationConstant.APP_AVTIVE);
					// 手机注册，直接激活
					userBase.setMobileConfirmed(MobileConfirmConstant.MOBILE_CONFIRMED);

					// wap用户注册时加默认头像和脸码
					if (source == SourceTypeConstant.WAP_SOURCE) {

						long start = System.currentTimeMillis();
						String avatar = DEFAULT_USER_AVATAR;
						UserAvatarSet userAvatarSet = qRcodeService.genQRcode(
								userBase.getUserId(), avatar, GenderType.MALE);
						long end = System.currentTimeMillis();
						logger.info("wap register generate default qrcode cost:"
								+ (end - start));
						userBase.setAvatar(avatar);
						userBase.setFaceQRCode(userAvatarSet.getQrAvatar());
						userBase.setFaceCodeType(userAvatarSet.getQrId());
					}
					// 默认微卡模板
					userBase.setWikaTemplate(DEFAULT_WIKA_TEMPLATE);
					// 插入基本信息表,二次检查，手机是否被用
					if (!isMobileUsed(mobile)) {
						userBaseDAO.insert(userBase);
						logger.info("insert user base while register");
						// 插入用户公司表
						UserOccupation userOccupation = new UserOccupation();
						userOccupation.setUserId(userId);
						occupationService.updateOccupation(userOccupation);
						// 用户默认设置表
						userSettingsService.addDefaultUserSettings(userId);
						registerReturn
								.setReturnCode(ResultCodeConstant.OP_SUCC);
						registerReturn.setUserId(userId);
						String profileShortUrl = shortUrlService
								.genWikaProfileShortUrl(userBase.getUserId());
						registerReturn.setProfileShortUrl(profileShortUrl);
						return registerReturn;
					} else {
						logger.info("register : has be registered may be two request ,mobile = "
								+ mobile);
						registerReturn
								.setReturnCode(AccountReturnCodeConstant.MOBILE_HAS_USED);
						return registerReturn;
					}
				} catch (Exception e) {
					logger.error("register error: mobile=  " + mobile, e);
					registerReturn.setReturnCode(ResultCodeConstant.OP_FAIL);
					return registerReturn;
				}
			} else {
				logger.info("register :  has be registered ,mobile = " + mobile);
				registerReturn
						.setReturnCode(AccountReturnCodeConstant.MOBILE_HAS_USED);
				return registerReturn;
			}
		}
	}

	@Override
	@Idempotent(value = false)
	public int changePassword(int userId, String oldPassword, String newPassword) {
		boolean newPwdValid = UserInfoValidator.passwordValidate(newPassword);
		if (!newPwdValid) {
			logger.info("change password fail:new password input is unvalid");
			return AccountReturnCodeConstant.PASSWORD_FORMAT_ERROR;
		}
		UserBase userBase = getUserBaseById(userId);
		if (null != userBase) {
			String pwd = userBase.getPassword();
			if (SecurityUtils.handlePassword(oldPassword, userId + "").equals(
					pwd)) {
				try {
					int result = userBaseDAO.updatePwd(
							userId,
							SecurityUtils.handlePassword(newPassword, userId
									+ ""));
					if (result == 1) {
						logger.info("change password success:user_id = "
								+ userId);
						return ResultCodeConstant.OP_SUCC;
					} else {
						logger.info("change password fail:user_id = " + userId);
						return ResultCodeConstant.OP_FAIL;
					}
				} catch (Exception e) {
					logger.info("update pwd error: user_id = " + userId);
					return ResultCodeConstant.OP_FAIL;
				}
			} else {
				return AccountReturnCodeConstant.OLD_PWD_ERROR;
			}
		} else {
			logger.info("there is no this user,user_id = " + userId);
			return ResultCodeConstant.OP_FAIL;
		}

	}

	@Override
	@Idempotent(value = false)
	public int bindMobile(int userId, String mobile, String verifyCode,
			String password) {
		boolean mobileValid = UserInfoValidator.mobileValidate(mobile);
		if (!mobileValid) {
			logger.info("bind mobile fail:mobile unvalid,mobile = " + mobile);
			return AccountReturnCodeConstant.MOBILE_FORMAT_ERROR;
		}
		if (!validatePhoneCode(mobile, verifyCode)) {
			logger.info("bind mobile fail:varify code error.user_id = "
					+ userId + ",mobile=" + mobile);
			return AccountReturnCodeConstant.VERIFY_CODE_ERROR;
		}
		try {
			if (!isMobileUsed(mobile)) {
				UserBase userBase = getUserBaseById(userId);
				String pwdMD5 = SecurityUtils.handlePassword(password, userId
						+ "");
				if (pwdMD5 != null && pwdMD5.equals(userBase.getPassword())) {
					if (mobile.equals(userBase.getMobile())) {
						logger.info("bind mobile is not change");
						return ResultCodeConstant.OP_SUCC;
					} else {
						int result = userBaseDAO.updateMobile(userId, mobile);
						logger.info("bind mobile: update database return "
								+ result);
						if (result > 0) {
							// 更新信息，通知好友
							UserPrivacySettings privacySettings = userSettingsService
									.getUserPrivacySettings(userId);
							if (privacySettings.getMobilePrivacy() != PrivacyType.SELF) {
								messageService.sendUserUpdateMessage(userId);
							}
							// 清除未确认这个号
							cleanUnconfirmedMobile(mobile);
							return ResultCodeConstant.OP_SUCC;
						} else {
							return ResultCodeConstant.OP_FAIL;
						}
					}
				} else {
					logger.info("bind mobile failed:error pwd,user_id = "
							+ userId);
					return AccountReturnCodeConstant.PASSWORD_ERROR;
				}
			} else {
				logger.info("bind mobile fail:mobile has been used.mobile = "
						+ mobile);
				return AccountReturnCodeConstant.MOBILE_HAS_USED;
			}
		} catch (Exception e) {
			logger.error("bind mobile error:", e);
			return ResultCodeConstant.OP_FAIL;
		}

	}

	@Override
	@Idempotent(value = false)
	public ActiveDJReturn activeDJAccount(int userId, String mobile,
			String verifyCode, String password, int source) {
		ActiveDJReturn activeDJReturn = new ActiveDJReturn();
		int returnCode = ResultCodeConstant.OP_FAIL;
		boolean mobileValid = UserInfoValidator.mobileValidate(mobile);
		if (!mobileValid) {
			logger.info("activeDJAccount fail:mobile unvalid,mobile = "
					+ mobile);
			activeDJReturn.setReturnCode(AccountReturnCodeConstant.MOBILE_FORMAT_ERROR);
			return activeDJReturn;
		}
		boolean passwordValid = UserInfoValidator.passwordValidate(password);
		if (!passwordValid) {
			logger.info("activeDJAccount fail:password unvalid");
			activeDJReturn.setReturnCode(AccountReturnCodeConstant.PASSWORD_FORMAT_ERROR);
			return activeDJReturn;
		}
		if (!validatePhoneCode(mobile, verifyCode)) {
			logger.info("activeDJAccount fail:varify code error.user_id = "
					+ userId + ",mobile=" + mobile);
			activeDJReturn.setReturnCode(AccountReturnCodeConstant.VERIFY_CODE_ERROR);
			return activeDJReturn;
		}
		try {
			if (!isMobileUsed(mobile)) {
				String pwdMD5 = SecurityUtils.handlePassword(password, userId
						+ "");
				int updateResult = userBaseDAO.updateMobileAndPwd(userId,
						mobile, pwdMD5);
				if (updateResult > 0) {
					cleanUnconfirmedMobile(mobile);
					UserBase userBase = getUserBaseById(userId);
					UserOccupation occupation = occupationService
							.getOccupation(userId);
					LoginUserView userView = constructLoginUserView(userBase,
							occupation);
					activeDJReturn.setLoginUserView(userView);
					boolean isComplete = isCompleteRequriedInfo(userBase,
							occupation, source);
					if (isComplete) {
						returnCode = ResultCodeConstant.OP_SUCC;
					} else {
						returnCode = AccountReturnCodeConstant.BASE_INFO_UNFINISED;
					}
				} else {
					returnCode = ResultCodeConstant.OP_FAIL;
				}
			} else {
				logger.info("activeDJAccount fail:mobile has been used.mobile = "
						+ mobile);
				returnCode = AccountReturnCodeConstant.MOBILE_HAS_USED;
			}
		} catch (Exception e) {
			logger.error("activeDJAccount error:", e);
			returnCode = ResultCodeConstant.OP_FAIL;
		}
		activeDJReturn.setReturnCode(returnCode);
		return activeDJReturn;
	}

	@Override
	@Idempotent(value = false)
	public int updateUserInfo(int userId, String wikaId, String name,
			String email, int gender, String location, String introduce,
			long birth, String corp, int industry, String position,
			int jobType, String department) {
		// 预处理，去除多余空格，中间空格只保留一个
		name = StringUtil.trim(name);
		position = StringUtil.trim(position);
		corp = StringUtil.trim(corp);
		department = StringUtil.trim(department);

		// 用户输出过滤
		wikaId = paramFilter(wikaId);
		location = paramFilter(location);
		introduce = paramFilter(introduce);
		corp = paramFilter(corp);
		position = paramFilter(position);
		department = paramFilter(department);

		// 参数校验
		int paramValid = validateBaseInfo(wikaId, name, email, gender,
				introduce, corp, position, department);
		if (paramValid != 0) {
			logger.info("update user info input param unvalid: return "
					+ paramValid + "user_id = " + userId);
			return paramValid;
		}

		// 更新前的原始信息
		UserBase oldUserBase = getUserBaseById(userId);
		UserOccupation oldOccupation = occupationService.getOccupation(userId);

		// 更新userbase
		UserBase userBase = new UserBase();
		userBase.setUserId(userId);
		userBase.setWikaId(wikaId);
		userBase.setName(name);
		userBase.setEmail(email);
		userBase.setGender(gender);
		userBase.setLocation(location);
		userBase.setIntroduce(introduce);
		if (birth > 0)
			userBase.setBirth(new Date(birth));
		int updateBaseResult = updateUserBaseNoAvatar(userBase);

		UserOccupation userOccupation = new UserOccupation();
		userOccupation.setUserId(userId);

		// 更新工作相关信息
		userOccupation.setCorp(corp);
		userOccupation.setIndustry(industry);
		userOccupation.setPosition(position);
		userOccupation.setDepartment(department);
		userOccupation.setJobType(jobType);
		int updateOccupationResult = occupationService
				.updateOccupation(userOccupation);

		// 发消息给好友,提示更新了微卡
		if (isNeedSendMessage(oldUserBase, oldOccupation, email, name, corp,
				position))
			messageService.sendUserUpdateMessage(userId);

		// 微卡身价更新
		refreshUserInfoValue(userId);
		return updateBaseResult > 0 && updateOccupationResult > 0 ? ResultCodeConstant.OP_SUCC
				: ResultCodeConstant.OP_FAIL;

	}

	@Override
	public int updateUserBase(UserBase userBase) {
		int result = userBaseDAO.update(userBase);
		if (result > 0) {
			logger.info("update userbase success:userId = "
					+ userBase.getUserId());
		} else {
			logger.info("update userbase fail:userId = " + userBase.getUserId());
		}
		return result;
	}

	@Override
	public int updateUserBaseNoAvatar(UserBase userBase) {
		int result = userBaseDAO.updateUserBaseNoAvatar(userBase);
		if (result > 0) {
			logger.info("update updateUserBaseNoAvatar success:userId = "
					+ userBase.getUserId());
		} else {
			logger.info("update updateUserBaseNoAvatar fail:userId = "
					+ userBase.getUserId());
		}
		return result;
	}

	@Override
	@Idempotent(value = false)
	public int changePasswordWithVerifyCode(String mobile, String verifyCode,
			String newPassword) {
		boolean validateResult = validatePhoneCode(mobile, verifyCode);
		if (!validateResult) {
			return AccountReturnCodeConstant.VERIFY_CODE_ERROR;
		} else if (!UserInfoValidator.passwordValidate(newPassword)) {
			return AccountReturnCodeConstant.PASSWORD_FORMAT_ERROR;
		} else {
			UserBase userBase = getUserBaseByMobile(mobile);
			if (userBase != null) {
				int userId = userBase.getUserId();
				try {
					int result = userBaseDAO.updatePwd(
							userId,
							SecurityUtils.handlePassword(newPassword, userId
									+ ""));
					if (result == 1) {
						logger.info("change password by mobile verify code success:mobile= "
								+ mobile);
						return ResultCodeConstant.OP_SUCC;
					} else {
						logger.info("change password by mobile verify code  fail:mobile = "
								+ mobile);
						return ResultCodeConstant.OP_FAIL;
					}
				} catch (Exception e) {
					logger.info("update pwd error: user_id = " + userId);
					return ResultCodeConstant.OP_FAIL;
				}
			}
			logger.info("change password by verify code :no user use this mobile");
			return ResultCodeConstant.OP_FAIL;
		}
	}

	@Override
	public boolean validateVerifyCode(String mobile, String verifyCode) {
		return validatePhoneCode(mobile, verifyCode);
	}

	@Override
	public UserBase getUserBaseById(int userId) {
		UserBase userBase = userBaseDAO.getUserBaseById(userId);
		return userBase;
	}

	@Override
	// 只有用户确认后的手机才有效
	public UserBase getUserBaseByMobile(String mobile) {
		UserBase userBase = userBaseDAO.getUserBaseByMobile(mobile);
		return userBase;
	}

	@Override
	public int updateUserQRCode(int userId, int faceCodeType, String faceQRCode) {
		try {
			int updateResult = userBaseDAO.updateUserQRCode(userId,
					faceCodeType, faceQRCode);
			return updateResult > 0 ? ResultCodeConstant.OP_SUCC
					: ResultCodeConstant.OP_FAIL;
		} catch (Exception e) {
			logger.info("update user face code error.", e);
			return ResultCodeConstant.OP_FAIL;
		}

	}

	@Override
	public int updateWikaTemplate(int userId, int wikaTemplate) {
		try {
			int updateResult = userBaseDAO.updateWikaTemplate(userId,
					wikaTemplate);
			return updateResult > 0 ? ResultCodeConstant.OP_SUCC
					: ResultCodeConstant.OP_FAIL;
		} catch (Exception e) {
			logger.info("update wika template error.", e);
			return ResultCodeConstant.OP_FAIL;
		}

	}

	@Override
	public List<UserBase> getUserBasesByIds(List<Integer> userIds) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<UserOccupation> getOccupationsByUserIds(List<Integer> userIds) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public void setWapActivity(int userId) {
		userBaseDAO.updateActivition(userId, UserActivationConstant.WAP_ACTIVE);
	}

	private void setAppActivity(int userId) {
		userBaseDAO.updateActivition(userId, UserActivationConstant.APP_AVTIVE);
	}

	@Override
	public int updateAvatar(int userId, String avatar) {
		try {
			int updateResult = userBaseDAO.updateAvatar(userId, avatar);
			if (updateResult > 0) {
				logger.info("update user avatar success,userId=" + userId);
				return ResultCodeConstant.OP_SUCC;
			} else {
				logger.info("update user avatar return " + updateResult
						+ ",userId=" + userId);
				return ResultCodeConstant.OP_FAIL;
			}
		} catch (Exception e) {
			logger.error("update user avatar fail,userId=" + userId, e);
			return ResultCodeConstant.OP_FAIL;
		}
	}

	@Override
	@Idempotent(value = false)
	public int updateAvatarAndQRCode(int userId, String avatar,
			int faceCodeType, String faceQRCode) {
		try {
			int updateResult = userBaseDAO.updateAvatarAndQRCode(userId,
					avatar, faceCodeType, faceQRCode);
			UserBase userBase = getUserBaseById(userId);
			int gender = GenderType.MALE;
			if (userBase != null) {
				gender = userBase.getGender();
			}
			if (gender != GenderType.MALE && gender != GenderType.FEMALE) {
				gender = GenderType.MALE;
			}
			// 异步生成其他模板脸码
			qRcodeService.genQRcode(userId, avatar, gender);
			if (updateResult > 0) {
				logger.info("update user avatar and qr_code success,userId="
						+ userId);
				refreshUserInfoValue(userId);
				return ResultCodeConstant.OP_SUCC;
			} else {
				logger.info("update user avatar and qr_code return "
						+ updateResult + ",userId=" + userId);
				return ResultCodeConstant.OP_FAIL;
			}
		} catch (Exception e) {
			logger.error(
					"update user avatar and qr_code fail,userId=" + userId, e);
			return ResultCodeConstant.OP_FAIL;
		}
	}

	private int updateAvatarAndQRCodeNoGenQR(int userId, String avatar,
			int faceCodeType, String faceQRCode) {
		try {
			int updateResult = userBaseDAO.updateAvatarAndQRCode(userId,
					avatar, faceCodeType, faceQRCode);
			if (updateResult > 0) {
				logger.info("update user avatar and qr_code no generate QR code success,userId="
						+ userId);
				refreshUserInfoValue(userId);
				return ResultCodeConstant.OP_SUCC;
			} else {
				logger.info("update user avatar and qr_code no generate QR code  return "
						+ updateResult + ",userId=" + userId);
				return ResultCodeConstant.OP_FAIL;
			}
		} catch (Exception e) {
			logger.error(
					"update user avatar and qr_code no generate QR code  fail,userId="
							+ userId, e);
			return ResultCodeConstant.OP_FAIL;
		}
	}

	private String getPhoneCode(String phone) {
		String code = cacheFactory.getPhoneCode(phone);
		if (NumberUtils.toInt(code) > 0) {
			return code;
		} else {
			String phoneCode = SMSUtil.getPhoneCode();
			cacheFactory.updatePhoneCode(phone, phoneCode);
			return phoneCode;
		}
	}

	private boolean validatePhoneCode(String phone, String code) {
		return code.equals(cacheFactory.getPhoneCode(phone));
	}

	// 所有参数均符合要求则返回0
	private int validateBaseInfo(String wikaId, String name, String email,
			int gender, String introduce, String corp, String position,
			String department) {
		if (!UserInfoValidator.nameValidate(name)) {
			return AccountReturnCodeConstant.NAME_FORMAT_ERROR;
		} else if (null != email && !UserInfoValidator.emailValidate(email)) {
			return AccountReturnCodeConstant.EMAIL_FORMAT_ERROR;
		} else if (gender < 0 || gender > 2) {
			return AccountReturnCodeConstant.GENDER_FORMAT_ERROR;
		} else if (!UserInfoValidator.corpValidate(corp)) {
			return AccountReturnCodeConstant.CORP_FORMAT_ERROR;
		} else if (!UserInfoValidator.positionValidate(position)) {
			return AccountReturnCodeConstant.POSITION_FORMAT_ERROR;
		} else if (null != department
				&& !UserInfoValidator.departmentValidate(department)) {
			return AccountReturnCodeConstant.DEPARTMENT_FORMAT_ERROR;
		} else if (null != wikaId && !UserInfoValidator.wikaIdValadate(wikaId)) {
			return AccountReturnCodeConstant.WIKA_FORMAT_ERROR;
		} else if (null != introduce
				&& !UserInfoValidator.introduceValidate(introduce)) {
			return AccountReturnCodeConstant.INTRODUCE_FORMAT_ERROR;
		}
		return 0;
	}

	private boolean isCompleteRequriedInfo(UserBase userBase,
			UserOccupation occupation, int source) {
		boolean isComplete = false;
		if (userBase != null && occupation != null) {
			String name = userBase.getName();
			String mobile = userBase.getMobile();
			String corp = occupation.getCorp();
			String position = occupation.getPosition();

			String avatar = userBase.getAvatar();
			// 如果头像不存在，并且来源是wap，添加默认头像
			if ((null == avatar || "".equals(avatar))
					&& source == SourceTypeConstant.WAP_SOURCE) {
				int gender = userBase.getGender();
				if (gender != GenderType.MALE && gender != GenderType.FEMALE) {
					gender = GenderType.MALE;
				}
				long start = System.currentTimeMillis();
				avatar = DEFAULT_USER_AVATAR;
				UserAvatarSet userAvatarSet = qRcodeService.genQRcode(
						userBase.getUserId(), avatar, gender);
				long end = System.currentTimeMillis();
				logger.info("generate default qrcode cost:" + (end - start));
				// 已执行异步生成其他模板的二维码，不需要再生成
				updateAvatarAndQRCodeNoGenQR(userBase.getUserId(),
						userAvatarSet.getAvatar(), userAvatarSet.getQrId(),
						userAvatarSet.getQrAvatar());
			}
			// 非空字段
			if (name != null && !name.equals("") && mobile != null
					&& !mobile.equals("") && corp != null && !corp.equals("")
					&& position != null && !position.equals("")
					&& null != avatar && !"".equals(avatar)) {
				isComplete = true;
			}
		}
		return isComplete;
	}

	@Override
	public boolean isCompleteRequriedInfo(int userId, int source) {
		UserBase userBase = getUserBaseById(userId);
		UserOccupation occupation = occupationService.getOccupation(userId);
		return isCompleteRequriedInfo(userBase, occupation, source);
	}

	@Override
	public boolean isCompleteRequriedInfo(int userId) {
		return isCompleteRequriedInfo(userId, SourceTypeConstant.APP_SOURCE);
	}

	private LoginUserView constructLoginUserView(UserBase userBase,
			UserOccupation occupation) {
		LoginUserView userView = new LoginUserView();
		if (userBase != null) {
			userView.setAvatar(userBase.getAvatar());
			userView.setEmail(userBase.getEmail());
			userView.setFeature(userBase.getFeature());
			userView.setGender(userBase.getGender());
			userView.setIntroduce(userBase.getIntroduce());
			userView.setMobile(userBase.getMobile());
			userView.setName(userBase.getName());
			userView.setStatus(userBase.getStatus());
			userView.setType(userBase.getType());
			userView.setWikaId(userBase.getWikaId());
		}
		if (occupation != null) {
			userView.setCorp(occupation.getCorp());
			userView.setDepartment(occupation.getDepartment());
			userView.setIndustry(occupation.getIndustry());
			userView.setJobType(occupation.getJobType());
			userView.setPosition(occupation.getPosition());
		}
		return userView;
	}

	private void activeWithLogin(UserBase userBase, int source) {
		// 更新用户激活状态
		int activation = userBase.getActivation();
		// app登陆，用户激活态低于app
		if (activation < UserActivationConstant.APP_AVTIVE
				&& source == SourceTypeConstant.APP_SOURCE) {
			setAppActivity(userBase.getUserId());
		}
		if (activation < UserActivationConstant.WAP_ACTIVE
				&& source == SourceTypeConstant.WAP_SOURCE) {
			setWapActivity(userBase.getUserId());
		}
	}

	@Override
	public boolean isMobileUsed(String mobile) {
		UserBase userBase = getUserBaseByMobile(mobile);
		if (userBase != null
				&& userBase.getMobileConfirmed() == MobileConfirmConstant.MOBILE_CONFIRMED) {
			return true;
		} else {
			return false;
		}
	}

	// 清除未确认的手机号
	private int cleanUnconfirmedMobile(String mobile) {
		try {
			int result = userBaseDAO.cleanUnconfirmedMobile(mobile);
			logger.info("clean unconfirmed mobile:return " + result);
			return result;
		} catch (Exception e) {
			logger.error("clean unconfirmed mobile:" + mobile, e);
			return 0;
		}

	}

	// 重新计算用户身价
	private void refreshUserInfoValue(int userId) {
		int completedUserInfoCount = getCompletedUserInfoCount(userId);
		userCountService.modifyUserInfoValue(userId, completedUserInfoCount);
	}

	// 是否需要发更新信息的消息
	private boolean isNeedSendMessage(UserBase oldUserBase,
			UserOccupation oldOccupation, String email, String name,
			String corp, String position) {
		if (oldUserBase == null || oldOccupation == null) {
			return false;
		}
		try {
			boolean isEmailChanged = !email.equals(oldUserBase.getEmail());
			boolean isNameChanged = !name.equals(oldUserBase.getName());
			boolean isCorpChanged = !corp.equals(oldOccupation.getCorp());
			boolean isPosition = !position.equals(oldOccupation.getPosition());
			return isEmailChanged || isNameChanged || isCorpChanged
					|| isPosition;
		} catch (Exception e) {
			logger.error("check is need send message cause exception,", e);
			return false;
		}
	}

	// 获取用户已完成的信息 个数
	private int getCompletedUserInfoCount(int userId) {
		UserBase userBase = getUserBaseById(userId);
		UserOccupation occupation = occupationService.getOccupation(userId);
		int completeUserInfoCount = 0;
		if (userBase != null) {
			if (null != userBase.getName() && !"".equals(userBase.getName())) {
				completeUserInfoCount++;
			}
			if (null != userBase.getEmail() && !"".equals(userBase.getEmail())) {
				completeUserInfoCount++;
			}
			if (null != userBase.getMobile()
					&& !"".equals(userBase.getMobile())) {
				completeUserInfoCount++;
			}
			if (null != userBase.getAvatar()
					&& !"".equals(userBase.getAvatar())) {
				completeUserInfoCount++;
			}
			if (null != userBase.getIntroduce()
					&& !"".equals(userBase.getIntroduce())) {
				completeUserInfoCount++;
			}
			if (null != userBase.getLocation()
					&& !"".equals(userBase.getLocation())) {
				completeUserInfoCount++;
			}
			if (userBase.getGender() >= 0) {
				completeUserInfoCount++;
			}

		}
		if (occupation != null) {
			if (occupation.getIndustry() > 0) {
				completeUserInfoCount++;
			}
			if (occupation.getJobType() > 0) {
				completeUserInfoCount++;
			}
			if (null != occupation.getDepartment()
					&& !"".equals(occupation.getDepartment())) {
				completeUserInfoCount++;
			}
			if (null != occupation.getCorp()
					&& !"".equals(occupation.getCorp())) {
				completeUserInfoCount++;
			}
			if (null != occupation.getPosition()
					&& !"".equals(occupation.getPosition())) {
				completeUserInfoCount++;
			}
		}
		return completeUserInfoCount;
	}

	private UserBase convert2UserBase(DJUserInfo djUserInfo, int userId) {
		UserBase userBase = new UserBase();
		userBase.setUserId(userId);
		if (djUserInfo != null) {
			userBase.setEmail(djUserInfo.getEmail());
			int gender = djUserInfo.getGender();
			if (gender != GenderType.MALE && gender != GenderType.FEMALE) {
				gender = GenderType.MALE;
			}
			userBase.setGender(gender);
			userBase.setName(djUserInfo.getName());
			String location = ParamXssStripper.filter(djUserInfo.getLocation());
			userBase.setLocation(location);
			userBase.setMobile(djUserInfo.getMobile());
			// 设置头像和二维码
			try {
				String djAvatar = djUserInfo.getAvatar();
				logger.info("convert2UserBase: dj avatar = " + djAvatar
						+ ",userId = " + userId + ",djId="
						+ djUserInfo.getDjId());
				if (djAvatar != null && !"".equals(djAvatar)) {
					String avatar = resourceService.uploadHttpFile(djAvatar);
					logger.info("upload dj_avatar return avatar:" + avatar
							+ ",userId = " + userId + ",djId="
							+ djUserInfo.getDjId());
					if (null != avatar && !"".equals(avatar)) {
						UserAvatarSet userAvatarSet = qRcodeService.genQRcode(
								userId, avatar, gender);

						if (null != userAvatarSet) {
							userBase.setAvatar(userAvatarSet.getAvatar());
							userBase.setFaceQRCode(userAvatarSet.getQrAvatar());
							userBase.setFaceCodeType(userAvatarSet.getQrId());
							logger.info("generate qr_code:avatar="
									+ userAvatarSet.getAvatar()
									+ ",face_code_type="
									+ userAvatarSet.getQrId() + ",qr_code="
									+ userAvatarSet.getQrAvatar());
						} else {
							logger.info("generate qr_code fail");
						}
					}
				}
			} catch (Exception e) {
				logger.error("generate qrcode from dj avatar error.", e);
			}
		}
		return userBase;
	}

	private UserOccupation convert2UserOccupation(DJUserInfo djUserInfo,
			int userId) {
		UserOccupation userOccupation = new UserOccupation();
		if (djUserInfo != null) {
			userOccupation.setUserId(userId);
			String corp = ParamXssStripper.filter(djUserInfo.getCorp());
			userOccupation.setCorp(corp);
			userOccupation.setIndustry(djUserInfo.getIndustry());
			userOccupation.setJobType(djUserInfo.getJobType());
			String position = ParamXssStripper.filter(djUserInfo.getPosition());
			userOccupation.setPosition(position);
		}
		return userOccupation;
	}

	private String paramFilter(String input) {
		String out = "";
		if (StringUtil.isEmpty(input)) {
			return out;
		} else {
			out = EmojiFilterUtil.emojiKiller(input);
			out = ParamXssStripper.filter(out);
		}
		return out;
	}

}
